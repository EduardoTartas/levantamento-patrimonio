# Plano de Teste para Model (Milestone 2 - Sprint 3)

| Funcionalidade                                  | Comportamento Esperado                                                                                                                               | Verificações                                                                                                                                  | Critérios de Aceite                                                                                                                                                                   |
| :---------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Validação de Campos Obrigatórios (Criação)      | Um usuário só pode ser cadastrado se possuir `campus`, `nome`, `CPF`, `email` e `cargo`.                                                              | Tentar salvar usuário sem `campus`, `nome`, `cpf`, `email` ou `cargo`.                                                                        | A operação deve falhar com erro de validação (`Path \`...\` is required`).                                                                                                                |
| Cadastro Válido de Usuário                      | Um usuário com campos obrigatórios válidos (senha opcional) deve ser salvo com sucesso, `status` padrão `true`, e timestamps.                             | Inserir usuário com todos os campos obrigatórios válidos (com e sem `senha`).                                                                 | Usuário salvo e retornado com `_id`, `createdAt`, `updatedAt`. Campo `status` é `true`. Se `senha` não fornecida, é `undefined` no banco.                                                  |
| Unicidade de CPF e Email                        | O sistema deve garantir que `CPF` e `email` sejam únicos na coleção.                                                                                   | Tentar cadastrar usuários com mesmo `cpf` ou mesmo `email`.                                                                                   | A segunda operação de salvamento deve falhar com erro de chave duplicada (`E11000 duplicate key error`) para o respectivo campo.                                                            |
| Validação de Formato de Campus                  | O campo `campus` deve ser um ObjectId válido.                                                                                                        | Tentar salvar usuário com `campus` que não é um ObjectId válido.                                                                              | A operação deve falhar com erro de cast para ObjectId (`Cast to ObjectId failed`).                                                                                                    |
| Leitura de Usuários                             | O sistema deve retornar todos os usuários cadastrados.                                                                                                 | Fazer `Usuario.find()` após cadastrar múltiplos usuários.                                                                                   | A consulta retorna um array com o número correto de usuários.                                                                                                                             |
| Atualização Genérica de Usuário                 | Deve ser possível atualizar campos como `nome`, `status`, `cargo` de um usuário existente. A senha deve permanecer inalterada se não fornecida.       | Alterar `nome`, `status`, `cargo` de um usuário existente sem enviar `senha` no payload.                                                    | Usuário reflete as alterações; `updatedAt` é atualizado. Senha original mantida.                                                                                                        |
| Validação em Atualização (Obrigatórios)         | Campos obrigatórios (ex: `nome`) não podem ser atualizados para valores vazios.                                                                          | Tentar atualizar o `nome` para string vazia.                                                                                                | A operação deve falhar com erro de validação (`Path \`nome\` is required`).                                                                                                              |
| Atualização/Remoção de Senha                    | Deve ser possível atualizar a senha para um novo valor ou "removê-la" (definindo como `undefined`).                                                      | Atualizar `senha` para novo valor; depois, atualizar `senha` para `undefined`.                                                              | Senha é alterada (ou seu hash). Ao ser definida como `undefined`, fica `undefined` no banco.                                                                                              |
| Remoção de Usuário                              | Um usuário existente pode ser removido do sistema.                                                                                                     | Usar `Usuario.deleteOne()` em um usuário existente.                                                                                         | Remoção bem-sucedida (`deletedCount` é 1) e usuário não é mais encontrado.                                                                                                               |

# Plano de Teste Controller (Milestone 2 - Sprint 3)

| Funcionalidade                     | Comportamento Esperado                                                                                                                      | Verificações                                                                                                                              | Critérios de Aceite                                                                                                                                                                                             |
| :--------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Listagem de Usuários (Geral)       | Deve listar todos os usuários (sem ID/query), filtrar por query, ou buscar por ID.                                                            | Chamar `listar()` sem parâmetros, com query válida, e com ID válido.                                                                      | Serviço chamado; `CommonResponse.success` com dados apropriados (lista total, filtrada ou individual).                                                                                                       |
| Validação de Entrada (Listagem)    | Deve propagar erro se a validação de ID (Zod) ou da query (Zod) falhar ao listar.                                                             | Chamar `listar()` com ID inválido ou query inválida.                                                                                      | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Criação de Usuário                 | Deve validar dados do corpo, chamar o serviço para criar, e retornar sucesso com dados do usuário (sem senha).                                  | Chamar `criar()` com dados válidos no corpo.                                                                                              | `UsuarioSchema.parse` e `UsuarioService.criar` são chamados. `CommonResponse.created` com dados do usuário (senha omitida).                                                                                |
| Validação de Entrada (Criação)     | Deve propagar erro se a validação dos dados do corpo (Zod) falhar ao criar.                                                                   | Chamar `criar()` com dados inválidos no corpo.                                                                                            | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Atualização de Usuário             | Deve validar ID e dados do corpo, chamar o serviço para atualizar, e retornar sucesso com mensagem e dados atualizados.                         | Chamar `atualizar()` com ID e corpo válidos.                                                                                              | Schemas de ID e Update são validados; `UsuarioService.atualizar` é chamado; `CommonResponse.success` com usuário atualizado e mensagem.                                                                       |
| Validação de Entrada (Atualização) | Deve propagar erro se a validação do ID (Zod) ou dos dados do corpo (Zod) falhar ao atualizar.                                              | Chamar `atualizar()` com ID inválido ou corpo inválido.                                                                                   | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Deleção de Usuário                 | Deve validar o ID, chamar o serviço para deletar, e retornar sucesso com mensagem e dados da deleção.                                         | Chamar `deletar()` com ID válido.                                                                                                         | `UsuarioIdSchema.parse` e `UsuarioService.deletar` são chamados; `CommonResponse.success` com resposta do serviço e mensagem.                                                                              |
| Validação de Entrada (Deleção)     | Deve propagar erro se a validação do ID (Zod) falhar ao deletar.                                                                              | Chamar `deletar()` com ID inválido.                                                                                                       | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Propagação de Erro do Serviço      | Deve propagar erros originados no `UsuarioService` para qualquer operação (listar, criar, atualizar, deletar).                                  | Mockar o método do serviço correspondente para lançar um erro.                                                                              | O método do controller correspondente lança o mesmo erro vindo do serviço.                                                                                                                                    |

# Plano de Teste Service (Milestone 2 - Sprint 3)

| Funcionalidade                                  | Comportamento Esperado                                                                                                                                  | Verificações                                                                                                                                                                  | Critérios de Aceite                                                                                                                                                                                                                                 |
| :---------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Listar Usuários (Serviço)                       | Deve chamar `repository.listar` com os parâmetros da requisição e retornar os dados.                                                                      | Chamar `service.listar(mockReq)`.                                                                                                                                           | `repository.listar` é chamado com `mockReq`; o resultado do repositório é retornado.                                                                                                                                                              |
| Criar Usuário (Serviço)                         | Deve validar unicidade de email/CPF, existência do campus, hashear senha (se fornecida), e chamar `repository.criar`.                                     | Chamar `service.criar(mockParsedData)` (com e sem senha). Mockar validações de unicidade/campus para sucesso.                                                                 | Validações e `bcrypt.hash` (se senha) são chamados. `repository.criar` é chamado com dados corretos (senha hasheada ou ausente). Usuário criado é retornado.                                                                                         |
| Falha ao Criar (Duplicidade/Campus Inexistente) | Deve lançar `CustomError` apropriado se email/CPF já existir ou campus não for encontrado.                                                                  | Chamar `service.criar` mockando `repository.buscarPorEmail/Cpf` para retornar usuário, ou `campusService.ensureCampExists` para falhar.                                   | Respectiva validação falha e lança `CustomError` (BAD\_REQUEST para duplicidade, ou erro do `campusService`). `repository.criar` não é chamado.                                                                                                |
| Atualizar Usuário (Serviço)                     | Deve garantir que usuário exista, validar unicidade de email/CPF (vs outros usuários), validar campus (se fornecido), e chamar `repository.atualizar`.      | Chamar `service.atualizar(userId, mockUpdateData)` (com e sem campus). Mockar `ensureUserExists`, validações de unicidade/campus para sucesso.                               | `ensureUserExists` e outras validações são chamadas. `repository.atualizar` é chamado com dados (sem email/senha explícitos, pois são tratados à parte ou não atualizáveis aqui). Usuário atualizado é retornado.                                |
| Falha ao Atualizar (Inválido/Duplicado)         | Deve lançar `CustomError` se usuário não existir, ou se novo email/CPF for duplicado (vs outros usuários), ou se novo campus não existir.                   | Chamar `service.atualizar` mockando `ensureUserExists` para falhar, ou `repository.buscarPorEmail/Cpf` para retornar outro usuário, ou `campusService.ensureCampExists` para falhar. | Respectiva validação falha e lança `CustomError` (NOT\_FOUND, BAD\_REQUEST para duplicidade, ou erro do `campusService`). `repository.atualizar` não é chamado.                                                                                   |
| Deletar Usuário (Serviço)                       | Deve garantir que o usuário exista e então chamar `repository.deletar`.                                                                                   | Chamar `service.deletar(userId)`. Mockar `ensureUserExists` para sucesso.                                                                                                     | `ensureUserExists` é chamado; `repository.deletar` é chamado; a resposta da deleção é retornada.                                                                                                                                                 |
| Falha ao Deletar (Usuário Inexistente)          | Deve lançar `CustomError` (NOT\_FOUND) se `ensureUserExists` falhar.                                                                                        | Chamar `service.deletar(idInexistente)`. Mockar `ensureUserExists` para falhar.                                                                                             | `ensureUserExists` é chamado e lança `CustomError` (NOT\_FOUND). `repository.deletar` não é chamado.                                                                                                                                            |
| Propagação de Erro do Repositório (Serviço)   | Deve propagar erros originados no `repository` ou `campusService` (exceto os tratados especificamente).                                                       | Mockar o método do repositório/`campusService` relevante para lançar um erro.                                                                                                 | A chamada ao método do serviço correspondente rejeita com o mesmo erro lançado.                                                                                                                                                                  |
| Auxiliares de Validação e Existência            | `validateEmail/Cpf` devem lançar `CustomError` (BAD\_REQUEST) se email/CPF em uso por outro. `ensureUserExists` lança `CustomError` (NOT\_FOUND) se não achar. | Chamar auxiliares com IDs/dados que causem sucesso e falha.                                                                                                                   | Repositório é chamado. `CustomError` apropriado é lançado em caso de falha de validação/existência. Nenhum erro se válido.                                                                                                                      |

# Plano de Teste Repository (Milestone 2 - Sprint 3)

| Funcionalidade                               | Comportamento Esperado                                                                                                                              | Verificações                                                                                                                                                                  | Critérios de Aceite                                                                                                                                                                                                |
| :------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Buscar Usuário por ID (`buscarPorId`)        | Deve buscar usuário por ID. Lança `CustomError` (NOT\_FOUND) se não encontrado.                                                                       | Chamar `repository.buscarPorId()` com ID existente e inexistente.                                                                                                               | `UsuarioModel.findById` é chamado. Retorna dados do usuário ou lança `CustomError` (404, "resourceNotFound", "Usuário").                                                                                             |
| Buscar Usuário por Email (`buscarPorEmail`)  | Deve buscar usuário por email, selecionando `+senha`. Retorna `null` se não encontrado.                                                               | Chamar `repository.buscarPorEmail()` com email existente e inexistente.                                                                                                     | `UsuarioModel.findOne({ email })` com `select('+senha')` é chamado. Retorna dados do usuário (com senha) ou `null`.                                                                                                |
| Buscar Usuário por CPF (`buscarPorCpf`)      | Deve buscar usuário por CPF. Retorna `null` se não encontrado.                                                                                        | Chamar `repository.buscarPorCpf()` com CPF existente e inexistente.                                                                                                           | `UsuarioModel.findOne({ cpf })` é chamado. Retorna dados do usuário ou `null`.                                                                                                                                      |
| Listar Usuários (`listar`)                   | Se ID: busca por ID com `populate`, `lean`. Se não: `UsuarioFilterBuilder`, `paginate` com opções, `populate`, `sort`, `lean`. Lida com padrões/limites. | Chamar `repository.listar()` com ID (`req.params.id`), e com várias queries (`req.query`) para filtros, paginação.                                                              | Para ID: `findById().populate().lean()` é chamado; retorna dados ou `CustomError` (404). Para query: `FilterBuilder` e `model.paginate()` são chamados com opções corretas; retorna dados paginados.                    |
| Falha Interna no `listar` (FilterBuilder)    | Deve lançar `CustomError` (500) se `filterBuilder.build` não for uma função.                                                                          | Chamar `repository.listar()` mockando `UsuarioFilterBuilder` para ter `build` inválido.                                                                                         | `CustomError` (500, "internalServerError", "Usuário") é lançado.                                                                                                                                                  |
| Criar Usuário (Repositório)                | Deve instanciar `UsuarioModel` com dados e chamar `save()`.                                                                                           | Chamar `repository.criar(novoUsuarioData)`.                                                                                                                                   | `UsuarioModel` é instanciado com dados; `save()` é chamado; usuário salvo é retornado.                                                                                                                            |
| Atualizar Usuário (Repositório)            | Deve usar `findByIdAndUpdate` com `new: true`, `populate`, `lean`. Lança `CustomError` (NOT\_FOUND) se não encontrado.                                 | Chamar `repository.atualizar()` com ID existente/inexistente e dados.                                                                                                           | `findByIdAndUpdate()` é chamado. Retorna dados atualizados ou lança `CustomError` (404, "resourceNotFound", "Usuário") se `findByIdAndUpdate` retorna `null`.                                                      |
| Deletar Usuário (Repositório)              | Deve usar `findByIdAndDelete`. Retorna o documento deletado ou `null` se não encontrado.                                                              | Chamar `repository.deletar()` com ID existente e inexistente.                                                                                                                 | `findByIdAndDelete()` é chamado. Retorna documento deletado ou `null`.                                                                                                                                               |
