# Plano de Teste para Model (Milestone 2 - Sprint 3)

| Funcionalidade                                  | Comportamento Esperado                                                                                                                               | Verificações                                                                                                                                  | Critérios de Aceite                                                                                                                                                                   |
| :---------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Validação de Campos Obrigatórios (Criação)      | Um usuário só pode ser cadastrado se possuir `campus`, `nome`, `CPF`, `email` e `cargo`.                                                              | Tentar salvar usuário sem `campus`, `nome`, `cpf`, `email` ou `cargo`.                                                                        | A operação deve falhar com erro de validação (`Path \`...\` is required`).                                                                                                                |
| Cadastro Válido de Usuário                      | Um usuário com campos obrigatórios válidos (senha opcional) deve ser salvo com sucesso, `status` padrão `true`, e timestamps.                             | Inserir usuário com todos os campos obrigatórios válidos (com e sem `senha`).                                                                 | Usuário salvo e retornado com `_id`, `createdAt`, `updatedAt`. Campo `status` é `true`. Se `senha` não fornecida, é `undefined` no banco.                                                  |
| Unicidade de CPF e Email                        | O sistema deve garantir que `CPF` e `email` sejam únicos na coleção.                                                                                   | Tentar cadastrar usuários com mesmo `cpf` ou mesmo `email`.                                                                                   | A segunda operação de salvamento deve falhar com erro de chave duplicada (`E11000 duplicate key error`) para o respectivo campo.                                                            |
| Validação de Formato de Campus                  | O campo `campus` deve ser um ObjectId válido.                                                                                                        | Tentar salvar usuário com `campus` que não é um ObjectId válido.                                                                              | A operação deve falhar com erro de cast para ObjectId (`Cast to ObjectId failed`).                                                                                                    |
| Leitura de Usuários                             | O sistema deve retornar todos os usuários cadastrados.                                                                                                 | Fazer `Usuario.find()` após cadastrar múltiplos usuários.                                                                                   | A consulta retorna um array com o número correto de usuários.                                                                                                                             |
| Atualização Genérica de Usuário                 | Deve ser possível atualizar campos como `nome`, `status`, `cargo` de um usuário existente. A senha deve permanecer inalterada se não fornecida.       | Alterar `nome`, `status`, `cargo` de um usuário existente sem enviar `senha` no payload.                                                    | Usuário reflete as alterações; `updatedAt` é atualizado. Senha original mantida.                                                                                                        |
| Validação em Atualização (Obrigatórios)         | Campos obrigatórios (ex: `nome`) não podem ser atualizados para valores vazios.                                                                          | Tentar atualizar o `nome` para string vazia.                                                                                                | A operação deve falhar com erro de validação (`Path \`nome\` is required`).                                                                                                              |
| Atualização/Remoção de Senha                    | Deve ser possível atualizar a senha para um novo valor ou "removê-la" (definindo como `undefined`).                                                      | Atualizar `senha` para novo valor; depois, atualizar `senha` para `undefined`.                                                              | Senha é alterada (ou seu hash). Ao ser definida como `undefined`, fica `undefined` no banco.                                                                                              |
| Remoção de Usuário                              | Um usuário existente pode ser removido do sistema.                                                                                                     | Usar `Usuario.deleteOne()` em um usuário existente.                                                                                         | Remoção bem-sucedida (`deletedCount` é 1) e usuário não é mais encontrado.                                                                                                               |

# Plano de Teste Controller (Milestone 2 - Sprint 3)

| Funcionalidade                     | Comportamento Esperado                                                                                                                      | Verificações                                                                                                                              | Critérios de Aceite                                                                                                                                                                                             |
| :--------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Listagem de Usuários (Geral)       | Deve listar todos os usuários (sem ID/query), filtrar por query, ou buscar por ID.                                                            | Chamar `listar()` sem parâmetros, com query válida, e com ID válido.                                                                      | Serviço chamado; `CommonResponse.success` com dados apropriados (lista total, filtrada ou individual).                                                                                                       |
| Validação de Entrada (Listagem)    | Deve propagar erro se a validação de ID (Zod) ou da query (Zod) falhar ao listar.                                                             | Chamar `listar()` com ID inválido ou query inválida.                                                                                      | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Criação de Usuário                 | Deve validar dados do corpo, chamar o serviço para criar, e retornar sucesso com dados do usuário (sem senha).                                  | Chamar `criar()` com dados válidos no corpo.                                                                                              | `UsuarioSchema.parse` e `UsuarioService.criar` são chamados. `CommonResponse.created` com dados do usuário (senha omitida).                                                                                |
| Validação de Entrada (Criação)     | Deve propagar erro se a validação dos dados do corpo (Zod) falhar ao criar.                                                                   | Chamar `criar()` com dados inválidos no corpo.                                                                                            | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Atualização de Usuário             | Deve validar ID e dados do corpo, chamar o serviço para atualizar, e retornar sucesso com mensagem e dados atualizados.                         | Chamar `atualizar()` com ID e corpo válidos.                                                                                              | Schemas de ID e Update são validados; `UsuarioService.atualizar` é chamado; `CommonResponse.success` com usuário atualizado e mensagem.                                                                       |
| Validação de Entrada (Atualização) | Deve propagar erro se a validação do ID (Zod) ou dos dados do corpo (Zod) falhar ao atualizar.                                              | Chamar `atualizar()` com ID inválido ou corpo inválido.                                                                                   | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Deleção de Usuário                 | Deve validar o ID, chamar o serviço para deletar, e retornar sucesso com mensagem e dados da deleção.                                         | Chamar `deletar()` com ID válido.                                                                                                         | `UsuarioIdSchema.parse` e `UsuarioService.deletar` são chamados; `CommonResponse.success` com resposta do serviço e mensagem.                                                                              |
| Validação de Entrada (Deleção)     | Deve propagar erro se a validação do ID (Zod) falhar ao deletar.                                                                              | Chamar `deletar()` com ID inválido.                                                                                                       | Controller lança erro de validação Zod; serviço não é chamado.                                                                                                                                                |
| Propagação de Erro do Serviço      | Deve propagar erros originados no `UsuarioService` para qualquer operação (listar, criar, atualizar, deletar).                                  | Mockar o método do serviço correspondente para lançar um erro.                                                                              | O método do controller correspondente lança o mesmo erro vindo do serviço.                                                                                                                                    |

# Plano de Teste Service (Milestone 2 - Sprint 3)

| Funcionalidade                                  | Comportamento Esperado                                                                                                                                  | Verificações                                                                                                                                                                  | Critérios de Aceite                                                                                                                                                                                                                                 |
| :---------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Listar Usuários (Serviço)                       | Deve chamar `repository.listar` com os parâmetros da requisição e retornar os dados.                                                                      | Chamar `service.listar(mockReq)`.                                                                                                                                           | `repository.listar` é chamado com `mockReq`; o resultado do repositório é retornado.                                                                                                                                                              |
| Criar Usuário (Serviço)                         | Deve validar unicidade de email/CPF, existência do campus, hashear senha (se fornecida), e chamar `repository.criar`.                                     | Chamar `service.criar(mockParsedData)` (com e sem senha). Mockar validações de unicidade/campus para sucesso.                                                                 | Validações e `bcrypt.hash` (se senha) são chamados. `repository.criar` é chamado com dados corretos (senha hasheada ou ausente). Usuário criado é retornado.                                                                                         |
| Falha ao Criar (Duplicidade/Campus Inexistente) | Deve lançar `CustomError` apropriado se email/CPF já existir ou campus não for encontrado.                                                                  | Chamar `service.criar` mockando `repository.buscarPorEmail/Cpf` para retornar usuário, ou `campusService.ensureCampExists` para falhar.                                   | Respectiva validação falha e lança `CustomError` (BAD\_REQUEST para duplicidade, ou erro do `campusService`). `repository.criar` não é chamado.                                                                                                |
| Atualizar Usuário (Serviço)                     | Deve garantir que usuário exista, validar unicidade de email/CPF (vs outros usuários), validar campus (se fornecido), e chamar `repository.atualizar`.      | Chamar `service.atualizar(userId, mockUpdateData)` (com e sem campus). Mockar `ensureUserExists`, validações de unicidade/campus para sucesso.                               | `ensureUserExists` e outras validações são chamadas. `repository.atualizar` é chamado com dados (sem email/senha explícitos, pois são tratados à parte ou não atualizáveis aqui). Usuário atualizado é retornado.                                |
| Falha ao Atualizar (Inválido/Duplicado)         | Deve lançar `CustomError` se usuário não existir, ou se novo email/CPF for duplicado (vs outros usuários), ou se novo campus não existir.                   | Chamar `service.atualizar` mockando `ensureUserExists` para falhar, ou `repository.buscarPorEmail/Cpf` para retornar outro usuário, ou `campusService.ensureCampExists` para falhar. | Respectiva validação falha e lança `CustomError` (NOT\_FOUND, BAD\_REQUEST para duplicidade, ou erro do `campusService`). `repository.atualizar` não é chamado.                                                                                   |
| Deletar Usuário (Serviço)                       | Deve garantir que o usuário exista e então chamar `repository.deletar`.                                                                                   | Chamar `service.deletar(userId)`. Mockar `ensureUserExists` para sucesso.                                                                                                     | `ensureUserExists` é chamado; `repository.deletar` é chamado; a resposta da deleção é retornada.                                                                                                                                                 |
| Falha ao Deletar (Usuário Inexistente)          | Deve lançar `CustomError` (NOT\_FOUND) se `ensureUserExists` falhar.                                                                                        | Chamar `service.deletar(idInexistente)`. Mockar `ensureUserExists` para falhar.                                                                                             | `ensureUserExists` é chamado e lança `CustomError` (NOT\_FOUND). `repository.deletar` não é chamado.                                                                                                                                            |
| Propagação de Erro do Repositório (Serviço)   | Deve propagar erros originados no `repository` ou `campusService` (exceto os tratados especificamente).                                                       | Mockar o método do repositório/`campusService` relevante para lançar um erro.                                                                                                 | A chamada ao método do serviço correspondente rejeita com o mesmo erro lançado.                                                                                                                                                                  |
| Auxiliares de Validação e Existência            | `validateEmail/Cpf` devem lançar `CustomError` (BAD\_REQUEST) se email/CPF em uso por outro. `ensureUserExists` lança `CustomError` (NOT\_FOUND) se não achar. | Chamar auxiliares com IDs/dados que causem sucesso e falha.                                                                                                                   | Repositório é chamado. `CustomError` apropriado é lançado em caso de falha de validação/existência. Nenhum erro se válido.                                                                                                                      |

# Plano de Teste Repository (Milestone 2 - Sprint 3)

| Funcionalidade                               | Comportamento Esperado                                                                                                                              | Verificações                                                                                                                                                                  | Critérios de Aceite                                                                                                                                                                                                |
| :------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Buscar Usuário por ID (`buscarPorId`)        | Deve buscar usuário por ID. Lança `CustomError` (NOT\_FOUND) se não encontrado.                                                                       | Chamar `repository.buscarPorId()` com ID existente e inexistente.                                                                                                               | `UsuarioModel.findById` é chamado. Retorna dados do usuário ou lança `CustomError` (404, "resourceNotFound", "Usuário").                                                                                             |
| Buscar Usuário por Email (`buscarPorEmail`)  | Deve buscar usuário por email, selecionando `+senha`. Retorna `null` se não encontrado.                                                               | Chamar `repository.buscarPorEmail()` com email existente e inexistente.                                                                                                     | `UsuarioModel.findOne({ email })` com `select('+senha')` é chamado. Retorna dados do usuário (com senha) ou `null`.                                                                                                |
| Buscar Usuário por CPF (`buscarPorCpf`)      | Deve buscar usuário por CPF. Retorna `null` se não encontrado.                                                                                        | Chamar `repository.buscarPorCpf()` com CPF existente e inexistente.                                                                                                           | `UsuarioModel.findOne({ cpf })` é chamado. Retorna dados do usuário ou `null`.                                                                                                                                      |
| Listar Usuários (`listar`)                   | Se ID: busca por ID com `populate`, `lean`. Se não: `UsuarioFilterBuilder`, `paginate` com opções, `populate`, `sort`, `lean`. Lida com padrões/limites. | Chamar `repository.listar()` com ID (`req.params.id`), e com várias queries (`req.query`) para filtros, paginação.                                                              | Para ID: `findById().populate().lean()` é chamado; retorna dados ou `CustomError` (404). Para query: `FilterBuilder` e `model.paginate()` são chamados com opções corretas; retorna dados paginados.                    |
| Falha Interna no `listar` (FilterBuilder)    | Deve lançar `CustomError` (500) se `filterBuilder.build` não for uma função.                                                                          | Chamar `repository.listar()` mockando `UsuarioFilterBuilder` para ter `build` inválido.                                                                                         | `CustomError` (500, "internalServerError", "Usuário") é lançado.                                                                                                                                                  |
| Criar Usuário (Repositório)                | Deve instanciar `UsuarioModel` com dados e chamar `save()`.                                                                                           | Chamar `repository.criar(novoUsuarioData)`.                                                                                                                                   | `UsuarioModel` é instanciado com dados; `save()` é chamado; usuário salvo é retornado.                                                                                                                            |
| Atualizar Usuário (Repositório)            | Deve usar `findByIdAndUpdate` com `new: true`, `populate`, `lean`. Lança `CustomError` (NOT\_FOUND) se não encontrado.                                 | Chamar `repository.atualizar()` com ID existente/inexistente e dados.                                                                                                           | `findByIdAndUpdate()` é chamado. Retorna dados atualizados ou lança `CustomError` (404, "resourceNotFound", "Usuário") se `findByIdAndUpdate` retorna `null`.                                                      |
| Deletar Usuário (Repositório)              | Deve usar `findByIdAndDelete`. Retorna o documento deletado ou `null` se não encontrado.                                                              | Chamar `repository.deletar()` com ID existente e inexistente.                                                                                                                 | `findByIdAndDelete()` é chamado. Retorna documento deletado ou `null`.                                                                                                                                               |

# Plano de Teste Endpoints (Milestone 3 - Sprint 7)

| Funcionalidade | Comportamento Esperado | Verificações | Critérios de Aceite |
| :--- | :--- | :--- | :--- |
| Listar usuários | Deve retornar todos os usuários via `GET /usuarios`. | Fazer requisição `GET /usuarios`. | A resposta contém um array com os usuários cadastrados e status 200. |
| Buscar por ID | Deve retornar o usuário correto via `GET /usuarios/:id`. | Fazer requisição `GET /usuarios/:id` com ID válido e inválido. | Retorna o usuário correto com dados do campus populados ou erro 404 se não encontrado. |
| Filtros de busca | Deve aplicar filtros via query params em `GET /usuarios`. | Fazer `GET /usuarios?nome=João&cargo=Comissionado&page=1&limite=5`. | Retorna apenas os usuários que atendem aos filtros aplicados com paginação. |
| Paginação | Deve retornar dados paginados com metadados via `GET /usuarios`. | Fazer `GET /usuarios?page=2&limite=5` com múltiplos usuários cadastrados. | Resposta contém `docs`, `totalDocs`, `page`, `totalPages`, `hasNextPage`, `hasPrevPage`. |
| Filtro por nome | Deve buscar usuários por nome (case-insensitive, regex) via query param. | Fazer `GET /usuarios?nome=joão` (minúsculo) para usuário com nome "João Silva". | Retorna usuários que contenham "joão" no nome, independente de case. |
| Filtro por email | Deve buscar usuários por email (case-insensitive, regex) via query param. | Fazer `GET /usuarios?email=@example.com` para usuários com email contendo "@example.com". | Retorna usuários cujo email contenha o texto especificado. |
| Filtro por CPF | Deve buscar usuários por CPF exato via query param. | Fazer `GET /usuarios?cpf=12345678909` para usuário com CPF exato. | Retorna apenas usuários com CPF exatamente igual ao especificado. |
| Filtro por cargo | Deve filtrar usuários por cargo via query param. | Fazer `GET /usuarios?cargo=Comissionado` e `GET /usuarios?cargo=Funcionario Cpalm`. | Retorna apenas usuários com o cargo especificado. |
| Filtro por status | Deve filtrar usuários por status ativo/inativo via query param. | Fazer `GET /usuarios?status=true` e `GET /usuarios?status=false`. | Retorna apenas usuários com status correspondente ao filtro. |
| Filtro por campus | Deve buscar usuários por ID do campus via query param. | Fazer `GET /usuarios?campus=507f1f77bcf86cd799439013` com ObjectId válido. | Retorna usuários do campus especificado com dados do campus populados. |
| Cadastrar usuário | Deve cadastrar um usuário via `POST /usuarios`. | Fazer `POST /usuarios` com dados válidos (nome, email, cpf, campus, cargo). | Usuário cadastrado sem senha e retornado com `_id` e status 201. |
| Cadastro inválido | Não deve cadastrar usuário com dados inválidos via `POST /usuarios`. | Fazer `POST /usuarios` sem campos obrigatórios ou com email/CPF duplicado. | Retorna erro 400 (dados inválidos) ou 409 (conflito) conforme o caso. |
| Atualizar usuário | Deve atualizar um usuário via `PATCH /usuarios/:id`. | Fazer `PATCH /usuarios/:id` com novos dados (nome, cargo, status). | Os dados do usuário são alterados corretamente e a resposta é 200. |
| Atualização inválida | Não deve atualizar usuário com ID inexistente ou dados inválidos. | Fazer `PATCH /usuarios/:id` com ID inexistente ou email duplicado. | Retorna erro 404 (não encontrado) ou 400/409 (dados inválidos/conflito). |
| Remover usuário | Deve remover um usuário via `DELETE /usuarios/:id`. | Fazer `DELETE /usuarios/:id` para usuário existente. | Usuário removido com sucesso, com status 200. |
| Remoção inválida | Não deve remover usuário com ID inexistente. | Fazer `DELETE /usuarios/:id` com ID inexistente. | Retorna erro 404. |
| Cadastrar senha | Deve permitir cadastro de senha via `POST /cadastrar-senha?token=xxx`. | Fazer `POST /cadastrar-senha?token=valid-token` com senha válida. | Senha cadastrada com sucesso e resposta 200. |
| Cadastro de senha inválido | Não deve cadastrar senha sem token ou com senha fraca. | Fazer `POST /cadastrar-senha` sem token ou com senha que não atenda aos critérios. | Retorna erro 400 com mensagem específica. |
| Validação de parâmetros | Deve retornar erro 400 para parâmetros inválidos. | Fazer `GET /usuarios/:id` com ID inválido, `GET /usuarios?page=0`, `GET /usuarios?limite=150`. | Retorna erro 400 com mensagem específica para cada tipo de validação. |
| Límite de paginação | Deve aplicar limite máximo de 100 registros por página. | Fazer `GET /usuarios?limite=200`. | Resposta limitada a 100 registros no máximo. |
| Populate de campus | Deve retornar dados do campus junto com cada usuário. | Fazer `GET /usuarios` e `GET /usuarios/:id`. | Cada usuário contém objeto `campus` com `_id` e `nome` do campus. |
| Exclusão de senha nas respostas | Não deve retornar campo senha em nenhuma resposta da API. | Fazer qualquer requisição que retorne dados de usuário. | Campo `senha` nunca aparece nas respostas, mesmo quando presente no banco. |
| Erro inesperado | Deve retornar erro 500 para falhas inesperadas nas rotas. | Simular erro interno em qualquer rota do usuário. | Retorna erro 500 e mensagem padronizada. |
| Query string vazia | Deve processar requisições sem query params usando valores padrão. | Fazer `GET /usuarios` sem parâmetros. | Retorna primeira página com 10 registros (valores padrão). |
| Múltiplos filtros | Deve aplicar múltiplos filtros simultaneamente. | Fazer `GET /usuarios?nome=João&cargo=Comissionado&status=true`. | Retorna apenas usuários que atendem a TODOS os filtros aplicados. |
| Validação de campos únicos | Deve impedir cadastro/atualização com email ou CPF já existente. | Tentar cadastrar/atualizar usuário com email ou CPF de outro usuário. | Retorna erro 409 (conflito) com mensagem indicando o campo duplicado. |
| Validação de campus | Deve validar se o campus existe antes de associar ao usuário. | Fazer `POST /usuarios` ou `PATCH /usuarios/:id` com campus inexistente. | Retorna erro 404 indicando que o campus não foi encontrado. |
| Autenticação nas rotas protegidas | Rotas de criação, atualização e remoção devem exigir autenticação. | Fazer `POST`, `PATCH`, `DELETE` sem token de autenticação válido. | Retorna erro 401 (não autorizado) para requisições sem autenticação. |
| Permissões nas rotas protegidas | Rotas de criação, atualização e remoção devem exigir permissões adequadas. | Fazer operações com usuário sem permissões adequadas. | Retorna erro 403 (proibido) para usuários sem permissão. |
